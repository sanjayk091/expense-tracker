<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, button { margin: 5px; padding: 5px; }
        table, th, td { border: 1px solid black; border-collapse: collapse; padding: 8px; }
    </style>
</head>
<body>
<h2>Expense Tracker</h2>

<!-- Form to Add Expense -->
<div>
    <h3>Add Expense</h3>
    <input id="category" placeholder="Category" required>
    <input id="amount" type="number" placeholder="Amount" required>
    <input id="date" type="date" placeholder="Date" required>
    <input id="desc" placeholder="Description" required>
    <button onclick="addExpense()">Add</button>
</div>


<!-- Table to Display All Expenses -->
<div>
    <h3>All Expenses</h3>
    <button onclick="getAll()">Refresh</button>
    <table id="expenses">
        <thead>
        <tr><th>ID</th><th>Category</th><th>Amount</th><th>Description</th><th>Date</th><th>Delete</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Filter Expenses by Category -->
<div>
    <h3>Filter by Category</h3>
    <input id="filterCat" placeholder="Category">
    <button onclick="getByCategory()">Get</button>
    <ul id="catResult"></ul>
</div>

<!-- Show Total Expense -->
<div>
    <h3>Total Expense</h3>
    <button onclick="getTotal()">Get Total</button>
    <p id="total"></p>
</div>

<!-- Show Total Expense by Category -->
<div>
    <h3>Total by Category</h3>
    <input id="totalCat" placeholder="Category">
    <button onclick="getTotalByCategory()">Get Total</button>
    <p id="totalByCat"></p>
</div>

<script>
    const api = '/api/expenses';

    // Add a new expense
    function addExpense() {
        fetch(api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                description: document.getElementById('desc').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value
            })
        }).then(() => getAll());
    }

    // Get all expenses
    function getAll() {
        fetch(`${api}/list`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('expenses').querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(e => {
                    const row = `<tr>
                        <td>${e.id}</td><td>${e.category}</td><td>${e.amount}</td><td>${e.description}</td><td>${e.date}</td>
                        <td><button onclick="deleteExpense(${e.id})">Delete</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
    }

    // Get expenses by category
    function getByCategory() {
        const category = document.getElementById('filterCat').value;

        // Clear the previous content first
        const list = document.getElementById('catResult');
        list.innerHTML = '';

        // Make the API call
        fetch(`${api}/category/${category}`)
            .then(res => {
                if (!res.ok) {
                    throw new Error('Failed to fetch expenses');
                }
                return res.json();
            })
            .then(data => {
                if (data.length === 0) {
                    list.innerHTML = '<p>No expenses found for this category.</p>';
                    return;
                }

                // Start building the table
                let table = `
                    <table border="1">
                        <thead>
                            <tr><th>Amount</th><th>Date</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                `;

                // Add rows to the table dynamically
                data.forEach(e => {
                    table += `
                        <tr>
                            <td>${e.amount}</td>
                            <td>${e.date}</td>
                            <td>${e.description}</td>
                        </tr>
                    `;
                });

                table += '</tbody></table>';

                // Append the table to the list
                list.innerHTML = table;
            })
            .catch(error => {
                list.innerHTML = `<p>Error: ${error.message}</p>`;
            });
    }


    // Get total expense
    function getTotal() {
        fetch(`${api}/total/all`)
            .then(res => res.text())
            .then(total => document.getElementById('total').innerText = `₹ ${total}`);
    }

    // Get total expense by category
    function getTotalByCategory() {
        const category = document.getElementById('totalCat').value;
        fetch(`${api}/total/category/${category}`)
            .then(res => res.text())
            .then(total => document.getElementById('totalByCat').innerText = `₹ ${total}`);
    }

    // Delete an expense
    function deleteExpense(id) {
        fetch(`${api}/${id}`, { method: 'DELETE' })
            .then(() => getAll());
    }

    // Refresh page on load
    window.onload = getAll;
</script>
</body>
</html>
